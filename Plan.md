# 方案文档

### 需求调研
1.基于QQ频道机器人的开放功能，完成拥有自定义功能的机器人开发。
2.不可直接使用官方SDK。

### 计划梳理
1. 申请QQ开放平台账号；
2. 申请QQ机器人（提前创建沙箱频道）；
3. 熟悉https://github.com/tencent-connect/botgo项目、https://bot.q.qq.com/wiki/develop/api/gateway/reference.html API文档 
4. 方案文档----业务部分；
5. 搭建Websocket建连、鉴权、事件监听注册； 
6. 封装开发平台API、Http请求客户端（获取Wss建连地址、推送消息）；
7. “打卡机器人”业务开发
8. 方案文档-----技术部分；

9. 整体时间安排：2022.08.27 - 2022.08.27 

### 业务梳理
“打卡机器人”支持以下四种指令功能：打卡指南、打卡、打卡排行榜、打卡详情

#### 1.打卡指南：
口令：@打卡机器人  打卡指南
期望：由机器人返回帮助文档，给出与打卡相关的所有指令集和相应解释；
      口令固定不变且无时间维度，指令集内指令和解释文案一一配对，希望做成可配置化；
限制：因允许每个用户调用时都成功（当然，也可做调用频次风控）
维度：/子频道。

#### 2.打卡：
口令：@打卡机器人 打卡
期望：A: 玩家一天内首次输入该口令，则由机器人返回"XXX用户成功打卡"；
     B: 玩家一天内非首次输入该口令，则由机器人返回"XXX用户今天已经打过卡啦"；
限制：一天内同个用户在同个子频道下仅成功一次。（当然，也可做调用频次风控）
维度：/天、/子频道。

#### 3.打卡排行榜：
口令：@打卡机器人 打卡排行榜
期望：排行榜记录一个月内打卡次数最多的一批玩家信息（自然月）
     由机器人返回本月内打卡次数最多的用户信息排行榜（Top10或者Top100）
     当无用户上榜时返回“无人上榜，赶紧来抢第一吧”。
限制：因允许每个用户调用时都成功（当然，也可做调用频次风控）
维度：/月、/子频道

####  4.打卡详情:
口令：@打卡机器人 打卡详情
期望：记录该玩家在一个月内的打卡次数、未打卡次数（自然月） ----（用户没上排行榜，但也想知道自己的记录）
限制：因允许每个用户调用时都成功（当然，也可做调用频次风控）
维度：/月、/子频道。

## 技术梳理

设计思路
·  封装Websocket SDK ，功能保留建连、鉴权、心跳，暂时去除重连逻辑；
·  封装HTTP SDK，统一API请求、响应；
·  封装官方API SDK，统一官方API调用；
·  监听事件仅保留并完成相应回调函数的业务逻辑（ATMessageEventHandler）；

####  打卡业务技术实现: 

1.打卡指南
   做法1：使用内存map[ string] [string] , 指令名称作为Key，指令对应解释为Value。（内存写死，每次修改必须重启 ）
   做法2：使用配置文件Json、或者数据库+缓存，获取数据后映射到Map中（更改配置可能需要等待缓存过期等）

2.打卡
   做法1：使用内存map[ string] [string] , （用户ID+年月日+子频道ID）作为Key，常量为Value。
          用户输入打卡指令时先查找map中是否存在该用户（内存记录，重启就丢数据 ）
   做法2：使用Redis缓存的setnex，将（用户ID+年月日+子频道ID）作为Key，Value值为常量，TTL为隔天零点与当前时间差值
          当用户为首次打卡时，将消息入Redis缓存，并落库MySQL。（需要考虑会不会高并发首次打卡，可以增加队列解决。）

3.打卡排行榜
   做法1：使用Redis缓存Zset，将（年月+子频道ID）作为Key，Member为该子频道下用户信息，Score作为当月打卡次数。
        （前提）需要在用户每日首次打卡时更新相应的Score。
   做法2：维护一张MySQL数据表，将用户打卡记录异步落库，后续用户查询时可以获取TOP100的用户信息，再将查询结果缓存到Redis。 （缓存则存在数据更新的实时性问题）

4.打卡详情
   做法1：获取打卡排行榜的缓存，根据Member 查询对应的打卡次数。
   做法2：根据MySQL表记录获取相应用户信息并添加至缓存（同打卡排行榜一样有数据更新的问题）

## 总结
1.程序调通，流程逻辑大致编写完成，业务逻辑已无时间开发。
2.整体业务流程基本上是：建立websocket连接，监听@机器人事件并回调重写的func处理业务逻辑和API自主封装。
3.因不能直接使用官方SDK，所以在websocket封装和API业务了解上几乎用了所有时间，更多是在剖解botgo项目源码和重写对应服务。
4.业务选择“打卡”，其整体产品设计和功能逻辑设计不难，但是没有过多时间考虑，本方案文档也未能好好撰写。



